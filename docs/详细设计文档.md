# 项目协作模块 - 详细设计文档

## 文档信息
- **文档版本**: V1.0
- **创建日期**: 2024年
- **最后更新**: 2024年
- **文档类型**: 详细设计文档
- **项目名称**: 奖金模拟系统 - 项目协作模块

## 1. 系统架构设计

### 1.1 总体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端展示层     │    │   业务逻辑层     │    │   数据持久层     │
│   (Vue 3)      │◄──►│   (Node.js)    │◄──►│   (MySQL)      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
│                      │                      │
├─ 用户界面组件        ├─ RESTful API        ├─ 项目数据表
├─ 状态管理 (Pinia)   ├─ 业务逻辑层        ├─ 用户权限表
├─ 路由管理          ├─ 权限中间件         ├─ 审批流程表
├─ HTTP客户端        ├─ 数据验证层         ├─ 通知消息表
└─ UI组件库          └─ 错误处理层         └─ 操作日志表
```

### 1.2 技术栈架构
**前端技术栈**
- **框架**: Vue 3 + TypeScript
- **UI库**: Element Plus
- **状态管理**: Pinia
- **路由**: Vue Router 4
- **构建工具**: Vite
- **HTTP客户端**: Axios

**后端技术栈**
- **运行环境**: Node.js
- **Web框架**: Express
- **ORM**: Sequelize
- **认证**: JWT
- **文档**: Swagger
- **日志**: Winston

**数据存储**
- **主数据库**: MySQL 8.0
- **缓存**: Redis (可选)
- **文件存储**: 本地文件系统

### 1.3 模块划分设计
```
项目协作模块
├── 前端模块 (frontend/)
│   ├── views/project/              # 页面组件
│   ├── components/                 # 通用组件
│   ├── api/                       # API接口
│   ├── store/                     # 状态管理
│   ├── router/modules/            # 路由模块
│   └── composables/               # 组合函数
├── 后端模块 (backend/)
│   ├── controllers/               # 控制器层
│   ├── models/                    # 数据模型
│   ├── routes/                    # 路由定义
│   ├── middlewares/               # 中间件
│   ├── services/                  # 业务服务
│   └── utils/                     # 工具函数
└── 数据库模块 (database/)
    ├── migrations/                # 数据迁移
    ├── seeders/                  # 初始数据
    └── schemas/                  # 表结构定义
```

## 2. 数据库设计

### 2.1 数据库ER模型
```
[Projects] ──────────── [ProjectRequirements]
    │                          │
    │ 1:N                      │
    ▼                          │
[ProjectTeamApplications]      │
    │                          │
    │ 1:N                      │
    ▼                          │
[ProjectTeamMembers]           │
    │                          │
    │ N:1                      │
    ▼                          ▼
[Employees] ──────────── [ProjectRoles]
    │
    │ 1:N
    ▼
[ProjectNotifications]
```

### 2.2 核心数据表设计

#### 2.2.1 项目表 (projects)
```sql
CREATE TABLE projects (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL COMMENT '项目名称',
    code VARCHAR(100) UNIQUE NOT NULL COMMENT '项目代码',
    description TEXT COMMENT '项目描述',
    work_content TEXT COMMENT '工作内容',
    budget DECIMAL(15,2) COMMENT '项目预算',
    bonus_scale DECIMAL(15,2) COMMENT '奖金规模',
    profit_target DECIMAL(15,2) COMMENT '利润目标',
    priority ENUM('low','medium','high','critical') DEFAULT 'medium',
    cooperation_status ENUM('published','team_building','pending_approval','approved','rejected','completed') DEFAULT 'published',
    start_date DATE COMMENT '开始日期',
    end_date DATE COMMENT '结束日期',
    created_by INT COMMENT '创建人ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id)
) COMMENT='项目基本信息表';
```

#### 2.2.2 项目需求表 (project_requirements)
```sql
CREATE TABLE project_requirements (
    id INT AUTO_INCREMENT PRIMARY KEY,
    project_id INT NOT NULL COMMENT '项目ID',
    requirement_type ENUM('technical','business','quality') NOT NULL COMMENT '需求类型',
    title VARCHAR(255) NOT NULL COMMENT '需求标题',
    description TEXT COMMENT '需求描述',
    priority ENUM('low','medium','high','critical') NOT NULL COMMENT '需求优先级',
    is_mandatory BOOLEAN DEFAULT TRUE COMMENT '是否必须',
    acceptance_criteria JSON COMMENT '验收标准',
    estimated_hours INT COMMENT '预估工时',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
) COMMENT='项目需求详情表';
```

#### 2.2.3 团队申请表 (project_team_applications)
```sql
CREATE TABLE project_team_applications (
    id INT AUTO_INCREMENT PRIMARY KEY,
    project_id INT NOT NULL COMMENT '项目ID',
    team_name VARCHAR(255) NOT NULL COMMENT '团队名称',
    team_description TEXT COMMENT '团队描述',
    application_reason TEXT COMMENT '申请理由',
    applicant_id INT NOT NULL COMMENT '申请人ID',
    estimated_cost DECIMAL(15,2) COMMENT '预估成本',
    total_members INT DEFAULT 0 COMMENT '团队人数',
    status ENUM('pending','approved','rejected','modified') DEFAULT 'pending',
    submitted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '提交时间',
    reviewed_by INT COMMENT '审批人ID',
    reviewed_at TIMESTAMP NULL COMMENT '审批时间',
    review_comments TEXT COMMENT '审批意见',
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
    FOREIGN KEY (applicant_id) REFERENCES users(id),
    FOREIGN KEY (reviewed_by) REFERENCES users(id)
) COMMENT='项目团队申请表';
```

#### 2.2.4 团队成员表 (project_team_members)
```sql
CREATE TABLE project_team_members (
    id INT AUTO_INCREMENT PRIMARY KEY,
    application_id INT NOT NULL COMMENT '申请ID',
    employee_id INT NOT NULL COMMENT '员工ID',
    role_id INT COMMENT '角色ID',
    role_name VARCHAR(100) COMMENT '角色名称',
    contribution_weight DECIMAL(3,2) DEFAULT 1.00 COMMENT '贡献权重',
    estimated_workload DECIMAL(3,2) COMMENT '工作量占比',
    allocation_percentage DECIMAL(5,2) COMMENT '分配比例',
    reason TEXT COMMENT '申请理由',
    status ENUM('pending','approved','rejected') DEFAULT 'pending',
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (application_id) REFERENCES project_team_applications(id) ON DELETE CASCADE,
    FOREIGN KEY (employee_id) REFERENCES employees(id),
    FOREIGN KEY (role_id) REFERENCES project_roles(id)
) COMMENT='项目团队成员表';
```

#### 2.2.5 项目角色表 (project_roles)
```sql
CREATE TABLE project_roles (
    id INT AUTO_INCREMENT PRIMARY KEY,
    role_name VARCHAR(100) NOT NULL COMMENT '角色名称',
    role_description TEXT COMMENT '角色描述',
    base_weight DECIMAL(3,2) DEFAULT 1.00 COMMENT '基础权重',
    skill_requirements JSON COMMENT '技能要求',
    responsibility_description TEXT COMMENT '职责描述',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) COMMENT='项目角色定义表';
```

#### 2.2.6 协作日志表 (project_collaboration_logs)
```sql
CREATE TABLE project_collaboration_logs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    project_id INT COMMENT '项目ID',
    application_id INT COMMENT '申请ID',
    user_id INT NOT NULL COMMENT '操作用户ID',
    operation_type ENUM('create','update','approve','reject','modify') NOT NULL,
    operation_description TEXT COMMENT '操作描述',
    old_data JSON COMMENT '变更前数据',
    new_data JSON COMMENT '变更后数据',
    ip_address VARCHAR(45) COMMENT 'IP地址',
    user_agent VARCHAR(500) COMMENT '用户代理',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id),
    FOREIGN KEY (application_id) REFERENCES project_team_applications(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
) COMMENT='项目协作操作日志表';
```

#### 2.2.7 通知表 (project_notifications)
```sql
CREATE TABLE project_notifications (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL COMMENT '接收用户ID',
    title VARCHAR(255) NOT NULL COMMENT '通知标题',
    content TEXT COMMENT '通知内容',
    notification_type ENUM('project_published','team_applied','approval_needed','approved','rejected','modification_required') NOT NULL,
    related_id INT COMMENT '关联ID',
    project_id INT COMMENT '项目ID',
    is_read BOOLEAN DEFAULT FALSE COMMENT '是否已读',
    read_at TIMESTAMP NULL COMMENT '读取时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
    INDEX idx_user_read (user_id, is_read),
    INDEX idx_created_at (created_at)
) COMMENT='项目通知消息表';
```

### 2.3 索引设计策略
```sql
-- 主要查询索引
CREATE INDEX idx_projects_status ON projects(cooperation_status);
CREATE INDEX idx_projects_created_by ON projects(created_by);
CREATE INDEX idx_projects_dates ON projects(start_date, end_date);

-- 申请查询索引  
CREATE INDEX idx_applications_project ON project_team_applications(project_id);
CREATE INDEX idx_applications_applicant ON project_team_applications(applicant_id);
CREATE INDEX idx_applications_status ON project_team_applications(status);

-- 成员查询索引
CREATE INDEX idx_members_application ON project_team_members(application_id);
CREATE INDEX idx_members_employee ON project_team_members(employee_id);

-- 通知查询索引
CREATE INDEX idx_notifications_user_status ON project_notifications(user_id, is_read);
CREATE INDEX idx_notifications_type ON project_notifications(notification_type);
```

## 3. API接口设计

### 3.1 RESTful API设计原则
- **资源导向**: URL表示资源，HTTP方法表示操作
- **状态无关**: 每个请求包含完整的执行信息
- **统一接口**: 标准化的请求响应格式
- **分层架构**: 清晰的控制器-服务-模型分层

### 3.2 API响应格式标准
```javascript
// 成功响应格式
{
  "code": 200,
  "message": "操作成功",
  "data": {
    // 具体数据内容
  },
  "pagination": {    // 分页信息（可选）
    "page": 1,
    "pageSize": 20,
    "total": 100,
    "totalPages": 5
  }
}

// 错误响应格式
{
  "code": 400,
  "message": "请求参数错误",
  "data": null,
  "errors": [        // 详细错误信息（可选）
    {
      "field": "name",
      "message": "项目名称不能为空"
    }
  ]
}
```

### 3.3 核心API接口设计

#### 3.3.1 项目管理API
```javascript
// 发布项目
POST /api/project-collaboration/publish
Authorization: Bearer <token>
Content-Type: application/json

Request Body:
{
  "name": "新项目名称",
  "code": "PROJECT_001",
  "description": "项目描述信息",
  "workContent": "详细工作内容",
  "budget": 100000,
  "bonusScale": 50000,
  "profitTarget": 200000,
  "priority": "high",
  "startDate": "2024-01-01",
  "endDate": "2024-12-31",
  "skillRequirements": ["JavaScript", "Vue.js"],
  "requirements": [
    {
      "type": "technical",
      "title": "前端开发需求",
      "description": "使用Vue3开发用户界面",
      "priority": "high",
      "isMandatory": true,
      "acceptanceCriteria": ["响应式设计", "兼容主流浏览器"]
    }
  ]
}

Response:
{
  "code": 201,
  "message": "项目发布成功",
  "data": {
    "project": {
      "id": 1,
      "name": "新项目名称",
      "code": "PROJECT_001",
      "cooperationStatus": "published",
      "createdAt": "2024-01-01T00:00:00.000Z"
    }
  }
}
```

```javascript
// 获取项目列表
GET /api/project-collaboration/projects
Authorization: Bearer <token>

Query Parameters:
- page: 页码 (default: 1)
- pageSize: 每页大小 (default: 20)
- search: 搜索关键词
- cooperationStatus: 协作状态筛选
- priority: 优先级筛选
- createdBy: 创建人筛选

Response:
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "projects": [
      {
        "id": 1,
        "name": "项目名称",
        "code": "PROJECT_001",
        "description": "项目描述",
        "cooperationStatus": "published",
        "budget": 100000,
        "bonusScale": 50000,
        "priority": "high",
        "createdBy": "管理员",
        "createdAt": "2024-01-01T00:00:00.000Z"
      }
    ],
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "total": 50,
      "totalPages": 3
    }
  }
}
```

#### 3.3.2 团队协作API
```javascript
// 申请团队组建
POST /api/project-collaboration/{projectId}/apply-team
Authorization: Bearer <token>
Content-Type: application/json

Request Body:
{
  "teamName": "开发团队",
  "teamDescription": "经验丰富的全栈开发团队",
  "applicationReason": "团队技能匹配项目需求",
  "estimatedCost": 80000,
  "members": [
    {
      "employeeId": 1,
      "roleId": 1,
      "roleName": "项目经理",
      "contributionWeight": 1.2,
      "estimatedWorkload": 0.3,
      "allocationPercentage": 30,
      "reason": "负责项目整体管理"
    },
    {
      "employeeId": 2,
      "roleId": 2,
      "roleName": "前端开发",
      "contributionWeight": 1.0,
      "estimatedWorkload": 0.7,
      "allocationPercentage": 70,
      "reason": "负责前端界面开发"
    }
  ]
}

Response:
{
  "code": 201,
  "message": "团队申请提交成功",
  "data": {
    "application": {
      "id": 1,
      "projectId": 1,
      "teamName": "开发团队",
      "status": "pending",
      "submittedAt": "2024-01-01T00:00:00.000Z"
    }
  }
}
```

```javascript
// 审批团队申请
POST /api/project-collaboration/applications/{applicationId}/approve
Authorization: Bearer <token>
Content-Type: application/json

Request Body:
{
  "action": "approve",  // approve, reject, modify
  "comments": "团队配置合理，同意组建",
  "modifications": [    // action为modify时需要
    {
      "memberId": 1,
      "action": "remove",
      "reason": "技能不匹配"
    }
  ]
}

Response:
{
  "code": 200,
  "message": "审批成功",
  "data": {
    "application": {
      "id": 1,
      "status": "approved",
      "reviewedAt": "2024-01-01T00:00:00.000Z",
      "reviewComments": "团队配置合理，同意组建"
    }
  }
}
```

#### 3.3.3 通知管理API
```javascript
// 获取我的通知
GET /api/project-collaboration/notifications/my
Authorization: Bearer <token>

Query Parameters:
- page: 页码
- pageSize: 每页大小
- unreadOnly: 只显示未读 (true/false)
- notificationType: 通知类型筛选

Response:
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "notifications": [
      {
        "id": 1,
        "title": "项目发布通知",
        "content": "新项目《测试项目》已发布，欢迎申请团队组建",
        "notificationType": "project_published",
        "isRead": false,
        "createdAt": "2024-01-01T00:00:00.000Z",
        "projectId": 1,
        "relatedId": 1
      }
    ],
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "total": 10
    },
    "unreadCount": 5
  }
}
```

### 3.4 权限中间件设计
```javascript
// 权限检查中间件
const checkPublishPermission = (req, res, next) => {
  try {
    // 检查用户认证状态
    if (!req.user) {
      return res.status(401).json({
        code: 401,
        message: '用户未认证',
        data: null
      })
    }

    // 检查权限
    const userPermissions = req.user.Role?.permissions || req.user.permissions || []
    if (!userPermissions.includes('*') && !userPermissions.includes('project:create')) {
      return res.status(403).json({
        code: 403,
        message: '您没有权限发布项目',
        data: null
      })
    }

    next()
  } catch (error) {
    res.status(500).json({
      code: 500,
      message: '权限检查失败',
      data: null
    })
  }
}
```

## 4. 前端组件设计

### 4.1 组件架构设计
```
项目协作前端组件
├── 页面组件 (Pages)
│   ├── ProjectCollaboration.vue      # 主协作页面
│   ├── ProjectPublish.vue           # 项目发布页面
│   └── ProjectManagement.vue        # 项目管理页面
├── 业务组件 (Business Components)
│   ├── TeamApplicationDialog.vue    # 团队申请对话框
│   ├── ApprovalDialog.vue          # 审批对话框
│   ├── ProjectDetailDialog.vue     # 项目详情对话框
│   ├── MemberSelectorDialog.vue    # 成员选择对话框
│   └── NotificationDrawer.vue      # 通知抽屉
├── 通用组件 (Common Components)
│   ├── ProjectCard.vue             # 项目卡片
│   ├── ApplicationCard.vue         # 申请卡片
│   ├── MemberTable.vue            # 成员表格
│   └── StatusTag.vue              # 状态标签
└── 布局组件 (Layout Components)
    ├── PageHeader.vue              # 页面头部
    ├── SearchFilter.vue           # 搜索筛选
    └── PaginationBar.vue          # 分页组件
```

### 4.2 核心组件设计

#### 4.2.1 ProjectCollaboration.vue 主页面设计
```vue
<template>
  <div class="project-collaboration">
    <!-- 页面头部 -->
    <div class="page-header">
      <h2>项目协作</h2>
      <div class="header-actions">
        <el-badge :value="unreadCount" :hidden="unreadCount === 0">
          <el-button @click="showNotifications">
            <el-icon><Bell /></el-icon>
            通知
          </el-button>
        </el-badge>
        <el-button type="primary" @click="$router.push('/project/publish')" v-if="canPublishProject">
          <el-icon><Plus /></el-icon>
          发布项目
        </el-button>
      </div>
    </div>

    <!-- 标签页 -->
    <el-tabs v-model="activeTab" @tab-change="handleTabChange">
      <!-- 项目列表标签页 -->
      <el-tab-pane label="项目列表" name="projects">
        <SearchFilter @search="handleSearch" @filter="handleFilter" />
        <div class="projects-grid">
          <ProjectCard 
            v-for="project in projects" 
            :key="project.id"
            :project="project"
            @apply="handleApply"
            @view-detail="handleViewDetail"
          />
        </div>
        <PaginationBar 
          :pagination="pagination"
          @page-change="handlePageChange"
        />
      </el-tab-pane>

      <!-- 待审批申请标签页 -->
      <el-tab-pane label="待审批申请" name="approvals" v-if="canApprove">
        <div class="applications-list">
          <ApplicationCard
            v-for="application in applications"
            :key="application.id"
            :application="application"
            @approve="handleApprove"
          />
        </div>
      </el-tab-pane>
    </el-tabs>

    <!-- 组件对话框 -->
    <TeamApplicationDialog 
      v-model="teamDialogVisible"
      :project="selectedProject"
      @success="handleTeamApplied"
    />
    
    <ApprovalDialog
      v-model="approvalDialogVisible" 
      :application="selectedApplication"
      @success="handleApprovalSuccess"
    />

    <NotificationDrawer
      v-model="notificationVisible"
      @notification-read="handleNotificationRead"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, computed, onMounted } from 'vue'
import { useProjectPermissions } from '@/composables/useProjectPermissions'
import { projectCollaborationApi } from '@/api/projectCollaboration'

// 权限检查
const { canPublishProject, canApprove } = useProjectPermissions()

// 响应式数据
const activeTab = ref('projects')
const projects = ref([])
const applications = ref([])
const unreadCount = ref(0)
const selectedProject = ref(null)
const selectedApplication = ref(null)

// 对话框状态
const teamDialogVisible = ref(false)
const approvalDialogVisible = ref(false)
const notificationVisible = ref(false)

// 分页信息
const pagination = reactive({
  page: 1,
  pageSize: 20,
  total: 0
})

// 业务方法
const loadProjects = async () => {
  try {
    const response = await projectCollaborationApi.getProjects({
      page: pagination.page,
      pageSize: pagination.pageSize
    })
    projects.value = response.data.projects
    Object.assign(pagination, response.data.pagination)
  } catch (error) {
    console.error('加载项目失败:', error)
  }
}

const handleApply = (project: any) => {
  selectedProject.value = project
  teamDialogVisible.value = true
}

const handleApprove = (application: any) => {
  selectedApplication.value = application
  approvalDialogVisible.value = true
}

// 生命周期
onMounted(() => {
  loadProjects()
})
</script>
```

#### 4.2.2 TeamApplicationDialog.vue 团队申请组件设计
```vue
<template>
  <el-dialog
    v-model="visible"
    title="申请团队组建"
    width="800px"
    :before-close="handleClose"
  >
    <el-form ref="formRef" :model="form" :rules="rules" label-width="120px">
      <!-- 基本信息 -->
      <el-card class="form-section" header="团队信息">
        <el-form-item label="团队名称" prop="teamName">
          <el-input v-model="form.teamName" placeholder="请输入团队名称" />
        </el-form-item>
        <el-form-item label="团队描述" prop="teamDescription">
          <el-input
            v-model="form.teamDescription"
            type="textarea"
            :rows="3"
            placeholder="请描述团队的特点和优势"
          />
        </el-form-item>
        <el-form-item label="申请理由" prop="applicationReason">
          <el-input
            v-model="form.applicationReason"
            type="textarea"
            :rows="3"
            placeholder="请说明申请理由"
          />
        </el-form-item>
        <el-form-item label="预估成本" prop="estimatedCost">
          <el-input-number
            v-model="form.estimatedCost"
            :precision="2"
            :step="1000"
            :min="0"
            placeholder="预估成本"
          />
        </el-form-item>
      </el-card>

      <!-- 团队成员 -->
      <el-card class="form-section" header="团队成员">
        <div class="members-section">
          <el-button @click="showMemberSelector" type="primary" plain>
            <el-icon><Plus /></el-icon>
            添加成员
          </el-button>
          
          <el-table :data="form.members" class="members-table">
            <el-table-column prop="employeeName" label="姓名" width="120" />
            <el-table-column prop="department" label="部门" width="120" />
            <el-table-column prop="position" label="岗位" width="120" />
            <el-table-column label="项目角色" width="150">
              <template #default="{ row, $index }">
                <el-input v-model="row.roleName" placeholder="角色名称" size="small" />
              </template>
            </el-table-column>
            <el-table-column label="贡献权重" width="120">
              <template #default="{ row }">
                <el-input-number
                  v-model="row.contributionWeight"
                  :precision="2"
                  :step="0.1"
                  :min="0.1"
                  :max="2.0"
                  size="small"
                />
              </template>
            </el-table-column>
            <el-table-column label="工作量占比" width="120">
              <template #default="{ row }">
                <el-input-number
                  v-model="row.estimatedWorkload"
                  :precision="2"
                  :step="0.1"
                  :min="0.1"
                  :max="1.0"
                  size="small"
                />
              </template>
            </el-table-column>
            <el-table-column label="分配比例" width="120">
              <template #default="{ row }">
                <el-input-number
                  v-model="row.allocationPercentage"
                  :precision="0"
                  :step="5"
                  :min="0"
                  :max="100"
                  size="small"
                />
              </template>
            </el-table-column>
            <el-table-column label="操作" width="100">
              <template #default="{ $index }">
                <el-button
                  size="small"
                  type="danger"
                  @click="removeMember($index)"
                >
                  删除
                </el-button>
              </template>
            </el-table-column>
          </el-table>
        </div>
      </el-card>
    </el-form>

    <template #footer>
      <div class="dialog-footer">
        <el-button @click="handleClose">取消</el-button>
        <el-button type="primary" :loading="submitting" @click="handleSubmit">
          提交申请
        </el-button>
      </div>
    </template>

    <!-- 成员选择器 -->
    <MemberSelectorDialog
      v-model="memberSelectorVisible"
      @confirm="handleMemberSelected"
    />
  </el-dialog>
</template>

<script setup lang="ts">
import { ref, reactive, computed, watch } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { projectCollaborationApi } from '@/api/projectCollaboration'
import MemberSelectorDialog from './MemberSelectorDialog.vue'

// Props
const props = defineProps<{
  modelValue: boolean
  project: any
}>()

// Emits
const emit = defineEmits<{
  'update:modelValue': [value: boolean]
  success: []
}>()

// 表单数据
const form = reactive({
  teamName: '',
  teamDescription: '',
  applicationReason: '',
  estimatedCost: 0,
  members: []
})

// 表单验证规则
const rules = {
  teamName: [
    { required: true, message: '请输入团队名称', trigger: 'blur' },
    { min: 2, max: 50, message: '团队名称长度在2到50个字符', trigger: 'blur' }
  ],
  teamDescription: [
    { required: true, message: '请输入团队描述', trigger: 'blur' },
    { min: 10, message: '团队描述至少10个字符', trigger: 'blur' }
  ],
  applicationReason: [
    { required: true, message: '请输入申请理由', trigger: 'blur' },
    { min: 20, message: '申请理由至少20个字符', trigger: 'blur' }
  ],
  estimatedCost: [
    { required: true, message: '请输入预估成本', trigger: 'blur' },
    { type: 'number', min: 1000, message: '预估成本至少1000元', trigger: 'blur' }
  ]
}

// 提交申请
const handleSubmit = async () => {
  try {
    await formRef.value?.validate()
    
    if (form.members.length === 0) {
      ElMessage.warning('请至少添加一名团队成员')
      return
    }

    // 验证分配比例总和
    const totalPercentage = form.members.reduce((sum, member) => sum + member.allocationPercentage, 0)
    if (totalPercentage !== 100) {
      ElMessage.warning('团队成员分配比例总和必须为100%')
      return
    }

    await ElMessageBox.confirm('确定要提交团队申请吗？', '确认提交')

    submitting.value = true
    await projectCollaborationApi.applyTeamBuilding(props.project.id, form)
    
    ElMessage.success('团队申请提交成功')
    emit('success')
    handleClose()
    
  } catch (error: any) {
    if (error !== 'cancel') {
      ElMessage.error(error.response?.data?.message || '提交失败')
    }
  } finally {
    submitting.value = false
  }
}
</script>
```

### 4.3 状态管理设计 (Pinia)
```typescript
// stores/projectCollaboration.ts
import { defineStore } from 'pinia'
import { projectCollaborationApi } from '@/api/projectCollaboration'

export const useProjectCollaborationStore = defineStore('projectCollaboration', {
  state: () => ({
    // 项目列表状态
    projects: [] as Project[],
    projectsLoading: false,
    projectsPagination: {
      page: 1,
      pageSize: 20,
      total: 0
    },
    
    // 申请列表状态
    applications: [] as Application[],
    applicationsLoading: false,
    
    // 通知状态
    notifications: [] as Notification[],
    unreadCount: 0,
    
    // 搜索筛选状态
    searchFilters: {
      search: '',
      cooperationStatus: '',
      priority: ''
    }
  }),

  getters: {
    // 获取已发布的项目
    publishedProjects: (state) => {
      return state.projects.filter(project => project.cooperationStatus === 'published')
    },
    
    // 获取待审批申请
    pendingApplications: (state) => {
      return state.applications.filter(app => app.status === 'pending')
    },
    
    // 获取未读通知
    unreadNotifications: (state) => {
      return state.notifications.filter(notification => !notification.isRead)
    }
  },

  actions: {
    // 加载项目列表
    async fetchProjects(params?: any) {
      this.projectsLoading = true
      try {
        const response = await projectCollaborationApi.getProjects({
          ...this.searchFilters,
          ...params,
          page: this.projectsPagination.page,
          pageSize: this.projectsPagination.pageSize
        })
        
        this.projects = response.data.projects
        this.projectsPagination = response.data.pagination
      } catch (error) {
        console.error('加载项目失败:', error)
        throw error
      } finally {
        this.projectsLoading = false
      }
    },

    // 发布项目
    async publishProject(projectData: any) {
      try {
        const response = await projectCollaborationApi.publishProject(projectData)
        // 重新加载项目列表
        await this.fetchProjects()
        return response
      } catch (error) {
        console.error('发布项目失败:', error)
        throw error
      }
    },

    // 申请团队组建
    async applyTeamBuilding(projectId: number, applicationData: any) {
      try {
        const response = await projectCollaborationApi.applyTeamBuilding(projectId, applicationData)
        // 重新加载相关数据
        await this.fetchProjects()
        return response
      } catch (error) {
        console.error('申请团队失败:', error)
        throw error
      }
    },

    // 加载通知列表
    async fetchNotifications() {
      try {
        const response = await projectCollaborationApi.getMyNotifications()
        this.notifications = response.data.notifications
        this.unreadCount = response.data.unreadCount
      } catch (error) {
        console.error('加载通知失败:', error)
        throw error
      }
    },

    // 标记通知已读
    async markNotificationRead(notificationId: number) {
      try {
        await projectCollaborationApi.markNotificationRead(notificationId)
        
        // 更新本地状态
        const notification = this.notifications.find(n => n.id === notificationId)
        if (notification && !notification.isRead) {
          notification.isRead = true
          notification.readAt = new Date()
          this.unreadCount = Math.max(0, this.unreadCount - 1)
        }
      } catch (error) {
        console.error('标记通知失败:', error)
        throw error
      }
    },

    // 更新搜索筛选条件
    updateSearchFilters(filters: any) {
      this.searchFilters = { ...this.searchFilters, ...filters }
      this.projectsPagination.page = 1 // 重置页码
    },

    // 重置状态
    resetState() {
      this.projects = []
      this.applications = []
      this.notifications = []
      this.unreadCount = 0
      this.projectsPagination = { page: 1, pageSize: 20, total: 0 }
      this.searchFilters = { search: '', cooperationStatus: '', priority: '' }
    }
  }
})
```

## 5. 业务流程设计

### 5.1 项目协作完整流程图
```
开始
  ↓
管理层发布项目
  ├─ 填写项目基本信息
  ├─ 设置预算和奖金规模  
  ├─ 定义技能要求
  ├─ 添加项目需求
  └─ 确认发布
  ↓
项目状态变更为"已发布"
  ↓
系统发送项目发布通知
  ↓
项目经理查看项目信息
  ↓
项目经理提交团队申请
  ├─ 填写团队信息
  ├─ 添加团队成员
  ├─ 分配角色权重
  └─ 提交申请
  ↓
申请状态变更为"待审批"
  ↓
系统发送审批通知给管理层
  ↓
管理层审查团队申请
  ├─ 查看团队构成
  ├─ 评估成本预算
  └─ 检查能力匹配
  ↓
管理层做出审批决定
  ├─ 批准 → 项目状态"已批准"
  ├─ 拒绝 → 申请状态"已拒绝"  
  └─ 修改 → 申请状态"需修改"
  ↓
系统发送审批结果通知
  ↓
[如果批准] 团队开始项目协作
[如果拒绝] 流程结束
[如果修改] 项目经理修改申请 → 重新审批
  ↓
结束
```

### 5.2 权限控制流程
```
用户访问请求
  ↓
身份认证检查
  ├─ Token有效性验证
  ├─ 用户信息获取
  └─ 会话状态检查
  ↓
权限验证检查
  ├─ 获取用户权限列表
  ├─ 检查操作权限要求
  └─ 权限匹配验证
  ↓
业务逻辑执行
  ├─ 数据访问控制
  ├─ 操作范围限制
  └─ 结果过滤处理
  ↓
审计日志记录
  ├─ 操作记录
  ├─ 权限使用记录
  └─ 异常情况记录
```

### 5.3 数据一致性保证流程
```
业务操作开始
  ↓
开启数据库事务
  ↓
执行业务逻辑
  ├─ 数据验证
  ├─ 业务规则检查
  ├─ 约束条件验证
  └─ 关联数据更新
  ↓
[成功] 提交事务
[失败] 回滚事务
  ↓
更新缓存状态
  ↓
发送事件通知
  ↓
记录操作日志
  ↓
返回操作结果
```

## 6. 安全设计

### 6.1 认证授权机制
- **JWT Token**: 无状态的用户认证
- **Token刷新**: 自动续期机制
- **权限继承**: 基于角色的权限继承
- **细粒度控制**: 功能级权限控制

### 6.2 数据安全防护
- **输入验证**: 严格的数据格式验证
- **SQL注入防护**: 参数化查询和ORM保护
- **XSS防护**: 输出转义和CSP策略
- **敏感数据加密**: 重要信息加密存储

### 6.3 操作审计机制
- **完整日志记录**: 关键操作全程记录
- **用户行为追踪**: 操作路径和时间记录
- **异常监控**: 异常访问和操作监控
- **合规性支持**: 满足审计和合规要求

---

## 7. 测试策略

### 7.1 测试金字塔
```
                    E2E Tests (10%)
                 ╱                 ╲
            Integration Tests (20%)
          ╱                         ╲
     Unit Tests (70%)
```

### 7.2 测试覆盖策略
- **单元测试**: 函数和组件级测试，覆盖率>90%
- **集成测试**: API接口和数据库集成测试  
- **端到端测试**: 用户流程和业务场景测试
- **性能测试**: 负载测试和压力测试
- **安全测试**: 权限验证和安全漏洞测试

---

*文档结束*